# 第2节：分布式事物系统

云原生应用对大规模的事务处理有着较为苛刻的需求。事务处理监控界于Client和Server之间，进行事务管理与协调、负载平衡、失败恢复等，以提高系统的整体性能。分布式事务系统中间件适用于联机交易处理系统，主要功能是管理分布于不同计算机上的数据的一致性，保障系统处理能力的效率与均衡负载。

业界著名的CAP理论告诉我们，在设计和实现一个分布式系统时，需要将数据一致性、系统可用性和分区容忍性放在一起考虑。而在分布式系统中，一致性（Consistency）、可用性（Availability）和分区容忍性（Partition Tolerance）这3个要素最多只能同时满足两个。一致性是指分布式环境下多个节点的数据是否强一致。可用性是指分布式服务能一直保证可用状态。当用户发出一个请求后，服务能在有限时间内返回结果。分区容忍性特指对网络分区的容忍性。分布式事务中间件的目的是保障分布式存储中数据一致性，而跨库事务会遇到各种不可控制的问题，如个别节点宕机。

目前主流的分布式事务解决方案有：

**a)**    TCC补偿型事务解决方案

TCC指的是Try（尝试）、Confirm（确认）、Cancel（取消），其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：

1. Try 阶段主要是对业务系统做检测及资源预留
2. Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。
3. Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。

**b)**   两阶段提交

两阶段提交（Two-phase Commit，2PC），通过引入协调者来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。

**c)**    本地消息表

1. 本地消息表与业务数据表处于同一个数据库中，这样就能利用本地事务来保证在对这两个表的操作满足事务特性，并且使用了消息队列来保证最终一致性。
2. 在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送一个消息，本地事务能保证这个消息一定会被写入本地消息表中。
3. 之后将本地消息表中的消息转发到 Kafka 等消息队列中，如果转发成功则将消息从本地消息表中删除，否则继续重新转发。
4. 在分布式事务操作的另一方从消息队列中读取一个消息，并执行消息中的操作。